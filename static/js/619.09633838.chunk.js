(self.webpackChunkmidispatcher=self.webpackChunkmidispatcher||[]).push([[619],{30619:function(e,t,n){"use strict";n.r(t),n.d(t,{MidiFileMachine:function(){return T}});var r,a,i,o,c,s,d,l,u,f,v=n(30168),h=n(1413),g=n(15671),p=n(43144),k=n(60136),m=n(27277),y=n(7894),I=n(60443),b=(n(47313),n(45808)),x=n(89209),w=n(47616),C=n(22089),M=n(46417),T=(0,C.xc)((a=function(e){(0,k.Z)(n,e);var t=(0,m.Z)(n);function n(e){var r;if((0,g.Z)(this,n),(r=t.call(this)).config=void 0,r.playing=!1,void 0==e){e={tracks:[],timeDivision:0,fileName:"None"};var a=document.createElement("input");a.type="file",a.accept=".mid, .midi",I.parse(a,(function(e){var t=n.createMidiConfig(e,a);r.getNode().addMachineOutPort(x.UL,0);for(var i=0;i<t.tracks.length;i++)r.getNode().addMachineOutPort(t.tracks[i].name,i+1);r.getNode().setSelected(!0),r.getNode().setSelected(!1),r.config=t})),a.click()}else{r.getNode().addMachineOutPort(x.UL,0);for(var i=0;i<e.tracks.length;i++)r.getNode().addMachineOutPort(e.tracks[i].name+"("+i+")",i+1),e.tracks[i].currentClock=0,e.tracks[i].currentEvent=0}return r.config=e,r.getNode().addMachineInPort("Clock",1),r}return(0,p.Z)(n,[{key:"getFactory",value:function(){return n.factory}},{key:"getState",value:function(){return this.config}},{key:"receive",value:function(e,t,n){switch(e.message.type){case"allnotesoff":n.setSending(!0);for(var r=0;r<this.config.tracks.length;r++)this.emit(e,r+1);break;case"continue":this.playing=!0,n.setSending(!0);break;case"start":this.playing=!0,n.setSending(!0);for(var a=0;a<this.config.tracks.length;a++)this.config.tracks[a].currentClock=0,this.config.tracks[a].currentEvent=0;break;case"stop":this.playing=!1,n.setSending(!0);for(var i=0;i<this.config.tracks.length;i++)this.emit(e,i+1);break;case"clock":if(!this.playing)return;n.setSending(!0);for(var o=[],c=0;c<this.config.tracks.length;c++){var s=this.config.tracks[c];if(s.events.length>s.currentEvent)for(s.currentClock+=this.config.timeDivision/24;void 0!=s.events[s.currentEvent]&&s.events[s.currentEvent].deltaTime<=s.currentClock;){"sysex"!==s.events[s.currentEvent].type&&o.push({signal:s.events[s.currentEvent],channel:c+1});var d=s.currentClock-s.events[s.currentEvent].deltaTime;s.currentEvent++,s.currentClock=0,d>0&&void 0!=s.events[s.currentEvent]&&(s.currentClock+=d)}}for(var l=0;l<o.length;l++)this.emit(o[l].signal,o[l].channel)}}}],[{key:"buildFactory",value:function(){return this.factory||(this.factory={createMachine:function(e){return new n(e)},createWidget:function(e,t){return(0,M.jsx)(E,{engine:e,size:50,node:t,machine:t.machine})},getType:function(){return C.Ax.Emitter},getName:function(){return"MidiFileMachine"},getTooltip:function(){return"Reads CLOCK message and sends out MIDI from file content"},getMachineCode:function(){return"midifile"}}),this.factory}},{key:"createMidiConfig",value:function(e,t){for(var n=[],r=0;r<e.track.length;r++){for(var a,i=e.track[r],o=void 0,c=[],s=0,d=0,l=function(e){var t=i.event[e];3!==t.metaType&&1!==t.metaType||void 0!=o||(o=t.data+" ");var n=[];n.push(t.type<<4),Array.isArray(t.data)?t.data.forEach((function(e){n.push(e)})):n.push(t.data);var a=Uint8Array.from(n),l=new b.v0(a),u={type:l.type,message:{rawData:a,isChannelMessage:l.isChannelMessage,type:l.type,channel:r+1}};"noteon"===u.type&&0!==u.message.rawData[2]?(s++,d=Math.max(d,s)):("noteoff"===u.type||"noteon"===u.type&&0===u.message.rawData[2])&&(s=Math.max(0,s-1)),c.push((0,h.Z)((0,h.Z)({},u),{},{deltaTime:t.deltaTime}))},u=0;u<e.track[r].event.length;u++)l(u);var f=r+1+". "+(null!==(a=o)&&void 0!==a?a:"unknown");f+=d>1?" ("+d+" voices)":1==d?" (mono)":" (silent)",n.push({currentClock:0,currentEvent:0,name:f,events:c,voices:d})}return{tracks:n,timeDivision:e.timeDivision,fileName:t.value.replace(/^.*[\\\/]/,"")}}}]),n}(C.Vs),a.factory=void 0,r=a))||r,E=function(e){function t(t){return(0,M.jsx)(w.kL,{engine:e.engine,port:t},t.getID())}return(0,M.jsxs)(u.Body,{"data-default-node-name":e.node.getOptions().name,selected:e.node.isSelected(),background:e.node.getOptions().color,children:[(0,M.jsx)(u.Title,{children:(0,M.jsx)(u.TitleName,{children:e.node.getOptions().name})}),(0,M.jsxs)(u.Ports,{children:[(0,M.jsx)(u.PortsContainer,{children:e.node.getInPorts().map(t)}),(0,M.jsx)(u.PortsContainer,{children:e.node.getOutPorts().map(t)})]}),(0,M.jsx)(u.SettingsBar,{children:(0,M.jsx)(u.TitleName,{children:e.node.machine.getState().fileName})})]})};(f=u||(u={})).SettingsBar=y.default.div(i||(i=(0,v.Z)(['\n        padding: 3px;\n        position: relative;\n        vertical-align: middle;\n        width: 100%;\n        display: flex;\n        justifyContent: "center";\n        flex-direction: column;\n    ']))),f.Title=y.default.div(o||(o=(0,v.Z)(["\n        background: rgba(0, 0, 0, 0.3);\n        display: flex;\n        white-space: nowrap;\n        justify-items: center;\n    "]))),f.TitleName=y.default.div(c||(c=(0,v.Z)(["\n        flex-grow: 1;\n        padding: 5px 5px;\n    "]))),f.Ports=y.default.div(s||(s=(0,v.Z)(["\n        display: flex;\n        background-image: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2));\n    "]))),f.PortsContainer=y.default.div(d||(d=(0,v.Z)(["\n        flex-grow: 1;\n        display: flex;\n        flex-direction: column;\n        &:first-of-type {\n\n            margin-right: 10px;\n        }\n        &:only-child {\n\n            margin-right: 0px;\n        }\n    "]))),f.Body=y.default.div(l||(l=(0,v.Z)(["\n        background-color: ",";\n        border-radius: 5px;\n        font-family: sans-serif;\n        color: white;\n        border: solid 2px black;\n        overflow: visible;\n        font-size: 11px;\n        border: solid 2px ",";\n\n    * {\n\n        box-sizing:border-box\n    }"])),(function(e){return e.background}),(function(e){return e.selected?"rgb(0,192,255)":"black"}))},60443:function(e){!function(){"use strict";var t={debug:!1,parse:function(e,n){if(e instanceof Uint8Array)return t.Uint8(e);if("string"===typeof e)return t.Base64(e);if(e instanceof HTMLElement&&"file"===e.type)return t.addListener(e,n);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(e,n){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(void 0===e||!(e instanceof HTMLElement)||"INPUT"!==e.tagName||"file"!==e.type.toLowerCase())return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;n=n||function(){},e.addEventListener("change",(function(e){if(!e.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");var r=new FileReader;r.readAsArrayBuffer(e.target.files[0]),r.onload=function(e){n(t.Uint8(new Uint8Array(e.target.result)))}}))},Base64:function(e){for(var n=function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";if(e=e.replace(/^.*?base64,/,""),e=String(e).replace(/[\t\n\f\r ]+/g,""),!/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/.test(e))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");e+="==".slice(2-(3&e.length));for(var n,r,a,i="",o=0;o<e.length;)n=t.indexOf(e.charAt(o++))<<18|t.indexOf(e.charAt(o++))<<12|(r=t.indexOf(e.charAt(o++)))<<6|(a=t.indexOf(e.charAt(o++))),i+=64===r?String.fromCharCode(n>>16&255):64===a?String.fromCharCode(n>>16&255,n>>8&255):String.fromCharCode(n>>16&255,n>>8&255,255&n);return i}(e=String(e)),r=n.length,a=new Uint8Array(new ArrayBuffer(r)),i=0;i<r;i++)a[i]=n.charCodeAt(i);return t.Uint8(a)},Uint8:function(e){var t={data:null,pointer:0,movePointer:function(e){return this.pointer+=e,this.pointer},readInt:function(e){if((e=Math.min(e,this.data.byteLength-this.pointer))<1)return-1;var t=0;if(e>1)for(var n=1;n<=e-1;n++)t+=this.data.getUint8(this.pointer)*Math.pow(256,e-n),this.pointer++;return t+=this.data.getUint8(this.pointer),this.pointer++,t},readStr:function(e){for(var t="",n=1;n<=e;n++)t+=String.fromCharCode(this.readInt(1));return t},readIntVLV:function(){var e=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)e=this.readInt(1);else{for(var t=[];this.data.getUint8(this.pointer)>=128;)t.push(this.readInt(1)-128);for(var n=this.readInt(1),r=1;r<=t.length;r++)e+=t[t.length-r]*Math.pow(128,r);e+=n}return e}};if(t.data=new DataView(e.buffer,e.byteOffset,e.byteLength),1297377380!==t.readInt(4))return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;t.readInt(4);var n={};n.formatType=t.readInt(2),n.tracks=t.readInt(2),n.track=[];var r=t.readInt(1),a=t.readInt(1);r>=128?(n.timeDivision=[],n.timeDivision[0]=r-128,n.timeDivision[1]=a):n.timeDivision=256*r+a;for(var i=1;i<=n.tracks;i++){n.track[i-1]={event:[]};var o=t.readInt(4);if(-1===o)break;if(1297379947!==o)return!1;t.readInt(4);for(var c=0,s=!1,d=void 0,l=void 0;!s&&(c++,n.track[i-1].event[c-1]={},n.track[i-1].event[c-1].deltaTime=t.readIntVLV(),-1!==(d=t.readInt(1)));)if(d>=128?l=d:(d=l,t.movePointer(-1)),255===d){n.track[i-1].event[c-1].type=255,n.track[i-1].event[c-1].metaType=t.readInt(1);var u=t.readIntVLV();switch(n.track[i-1].event[c-1].metaType){case 47:case-1:s=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:n.track[i-1].event[c-1].data=t.readStr(u);break;case 33:case 89:case 81:n.track[i-1].event[c-1].data=t.readInt(u);break;case 84:n.track[i-1].event[c-1].data=[],n.track[i-1].event[c-1].data[0]=t.readInt(1),n.track[i-1].event[c-1].data[1]=t.readInt(1),n.track[i-1].event[c-1].data[2]=t.readInt(1),n.track[i-1].event[c-1].data[3]=t.readInt(1),n.track[i-1].event[c-1].data[4]=t.readInt(1);break;case 88:n.track[i-1].event[c-1].data=[],n.track[i-1].event[c-1].data[0]=t.readInt(1),n.track[i-1].event[c-1].data[1]=t.readInt(1),n.track[i-1].event[c-1].data[2]=t.readInt(1),n.track[i-1].event[c-1].data[3]=t.readInt(1);break;default:null!==this.customInterpreter&&(n.track[i-1].event[c-1].data=this.customInterpreter(n.track[i-1].event[c-1].metaType,t,u)),null!==this.customInterpreter&&!1!==n.track[i-1].event[c-1].data||(t.readInt(u),n.track[i-1].event[c-1].data=t.readInt(u),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch((d=d.toString(16).split(""))[1]||d.unshift("0"),n.track[i-1].event[c-1].type=parseInt(d[0],16),n.track[i-1].event[c-1].channel=parseInt(d[1],16),n.track[i-1].event[c-1].type){case 15:if(null!==this.customInterpreter&&(n.track[i-1].event[c-1].data=this.customInterpreter(n.track[i-1].event[c-1].type,t,!1)),null===this.customInterpreter||!1===n.track[i-1].event[c-1].data){var f=t.readIntVLV();n.track[i-1].event[c-1].data=t.readInt(f),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer")}break;case 10:case 11:case 14:case 8:case 9:n.track[i-1].event[c-1].data=[],n.track[i-1].event[c-1].data[0]=t.readInt(1),n.track[i-1].event[c-1].data[1]=t.readInt(1);break;case 12:case 13:n.track[i-1].event[c-1].data=t.readInt(1);break;case-1:s=!0;break;default:if(null!==this.customInterpreter&&(n.track[i-1].event[c-1].data=this.customInterpreter(n.track[i-1].event[c-1].metaType,t,!1)),null===this.customInterpreter||!1===n.track[i-1].event[c-1].data)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return n},customInterpreter:null};e.exports=t}()}}]);